# TrackFlow Collaboration Invitation System - Definitive Implementation Plan

## Overview

Replace the current hardcoded collaborator addition with a proper invitation system that requires user consent before adding collaborators to projects. This plan incorporates feedback for cleaner architecture and better separation of concerns.

## Current Problems

1. **Direct Addition**: Users are added to projects without consent
2. **Hardcoded IDs**: Using email as UserId instead of proper user lookup
3. **No Invitation Flow**: No way to invite users who don't exist in the system
4. **No Notifications**: No way to notify users of pending invitations
5. **Poor Architecture**: Single bloc handling multiple responsibilities

## Proposed Solution: Invitation-Based Collaboration

### Core Principles

- **Explicit Consent**: Users must accept invitations before joining projects
- **Dual Flow**: Support both existing users and new users
- **Clean Architecture**: Separate Actor/Watcher BLoCs for better separation of concerns
- **Notification Integration**: Automatic notification creation and management
- **Magic Link Integration**: Seamless onboarding for new users

### Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Presentation  â”‚    â”‚     Domain      â”‚    â”‚      Data       â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚Actor BLoC   â”‚ â”‚    â”‚ â”‚Use Cases    â”‚ â”‚    â”‚ â”‚Repositories â”‚ â”‚
â”‚ â”‚             â”‚ â”‚    â”‚ â”‚             â”‚ â”‚    â”‚ â”‚             â”‚ â”‚
â”‚ â”‚â€¢ Send Inv   â”‚ â”‚    â”‚ â”‚â€¢ Send Inv   â”‚ â”‚    â”‚ â”‚â€¢ Local DB   â”‚ â”‚
â”‚ â”‚â€¢ Accept Inv â”‚ â”‚    â”‚ â”‚â€¢ Accept Inv â”‚ â”‚    â”‚ â”‚â€¢ Remote API â”‚ â”‚
â”‚ â”‚â€¢ Decline Invâ”‚ â”‚    â”‚ â”‚â€¢ Decline Invâ”‚ â”‚    â”‚ â”‚â€¢ Cache      â”‚ â”‚
â”‚ â”‚â€¢ Cancel Inv â”‚ â”‚    â”‚ â”‚â€¢ Cancel Inv â”‚ â”‚    â”‚ â”‚             â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚Watcher BLoC â”‚ â”‚    â”‚ â”‚Entities     â”‚ â”‚    â”‚ â”‚DTOs         â”‚ â”‚
â”‚ â”‚             â”‚ â”‚    â”‚ â”‚             â”‚ â”‚    â”‚ â”‚             â”‚ â”‚
â”‚ â”‚â€¢ Watch Inv  â”‚ â”‚    â”‚ â”‚â€¢ Invitation â”‚ â”‚    â”‚ â”‚â€¢ Invitation â”‚ â”‚
â”‚ â”‚â€¢ Watch Notifâ”‚ â”‚    â”‚ â”‚â€¢ Notificationâ”‚ â”‚    â”‚ â”‚â€¢ Notificationâ”‚ â”‚
â”‚ â”‚â€¢ Counts     â”‚ â”‚    â”‚ â”‚â€¢ Status     â”‚ â”‚    â”‚ â”‚â€¢ Status     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Implementation Phases

### Phase 1: Domain Layer âœ… (COMPLETED)

**Status**: âœ… **COMPLETED** - All domain components created

#### âœ… Completed Tasks:

- [x] **InvitationId** - Unique identifier for invitations
- [x] **NotificationId** - Unique identifier for notifications
- [x] **ProjectInvitation** - Core invitation entity with domain methods
- [x] **NotificationEntity** - Notification entity with factory methods
- [x] **InvitationRepository** - Repository interface (Actor/Watcher pattern)
- [x] **NotificationRepository** - Repository interface for notifications
- [x] **FindUserByEmailUseCase** - Search for existing users
- [x] **SendInvitationUseCase** - Send invitations (existing + new users)
- [x] **AcceptInvitationUseCase** - Accept invitations and add to project
- [x] **DeclineInvitationUseCase** - Decline invitations
- [x] **ObservePendingInvitationsUseCase** - Watch pending invitations
- [x] **ObserveSentInvitationsUseCase** - Watch sent invitations
- [x] **ObserveNotificationsUseCase** - Watch notifications
- [x] **MarkNotificationAsReadUseCase** - Mark notifications as read
- [x] **MarkAllNotificationsAsReadUseCase** - Mark all as read
- [x] **GetUnreadNotificationsCountUseCase** - Get unread count
- [x] **GetPendingInvitationsCountUseCase** - Get pending count
- [x] **CancelInvitationUseCase** - Cancel sent invitations
- [x] **InvitationExceptions** - Domain exceptions
- [x] **InvitationFailures** - Domain failures
- [x] **Domain Barrel File** - Export all domain components

#### ğŸ”§ Issues to Fix:

- [ ] **ID Classes Constructor Issue** - Fix InvitationId and NotificationId constructors
- [ ] **ProjectRepository Integration** - Add when ProjectRepository is available
- [ ] **UserProfileRepository Integration** - Add when UserProfileRepository is available

### Phase 2: Data Layer

**Status**: ğŸ”„ **IN PROGRESS** - Next phase to implement

#### Tasks:

- [ ] **InvitationDto** - Data transfer object for invitations
- [ ] **NotificationDto** - Data transfer object for notifications
- [ ] **InvitationLocalDataSource** - Local database operations
- [ ] **NotificationLocalDataSource** - Local database operations
- [ ] **InvitationRemoteDataSource** - Remote API operations
- [ ] **NotificationRemoteDataSource** - Remote API operations
- [ ] **InvitationRepositoryImpl** - Repository implementation
- [ ] **NotificationRepositoryImpl** - Repository implementation
- [ ] **InvitationMapper** - Entity â†” DTO mapping
- [ ] **NotificationMapper** - Entity â†” DTO mapping
- [ ] **Data Barrel File** - Export all data components

### Phase 3: Split BLoCs

**Status**: â³ **PENDING**

#### Tasks:

- [ ] **ProjectInvitationWatcherBloc** - Observe invitation state changes
- [ ] **ProjectInvitationActorBloc** - Handle user actions
- [ ] **NotificationWatcherBloc** - Observe notification state changes
- [ ] **NotificationActorBloc** - Handle notification actions
- [ ] **InvitationStates** - State classes for invitation BLoCs
- [ ] **NotificationStates** - State classes for notification BLoCs
- [ ] **InvitationEvents** - Event classes for invitation BLoCs
- [ ] **NotificationEvents** - Event classes for notification BLoCs

### Phase 4: UI Components

**Status**: â³ **PENDING**

#### Tasks:

- [ ] **SendInvitationForm** - Form to send invitations
- [ ] **PendingInvitationsList** - List of pending invitations
- [ ] **SentInvitationsList** - List of sent invitations
- [ ] **InvitationCard** - Individual invitation display
- [ ] **NotificationCenterScreen** - Main notification screen
- [ ] **NotificationList** - List of notifications
- [ ] **NotificationCard** - Individual notification display
- [ ] **InvitationActionButtons** - Accept/Decline buttons

### Phase 5: Notification System

**Status**: â³ **PENDING**

#### Tasks:

- [ ] **NotificationBadge** - Badge showing unread count
- [ ] **NotificationIcon** - Icon with notification indicator
- [ ] **NotificationDrawer** - Drawer for notifications
- [ ] **NotificationSettings** - Notification preferences
- [ ] **NotificationSound** - Sound for new notifications
- [ ] **NotificationVibration** - Vibration for notifications

### Phase 6: Magic Link Integration

**Status**: â³ **PENDING**

#### Tasks:

- [ ] **Update MagicLinkRepository** - Add invitation support
- [ ] **InvitationMagicLink** - Magic link for invitations
- [ ] **EmailTemplateService** - Email template generation
- [ ] **EmailSendingService** - Email sending functionality
- [ ] **MagicLinkHandler** - Handle invitation magic links
- [ ] **InvitationSignupFlow** - Signup flow for invited users
- [ ] **AutoJoinProject** - Automatically join project after signup

### Phase 7: Integration & Updates

**Status**: â³ **PENDING**

#### Tasks:

- [ ] **Update ProjectRepository** - Add collaborator management
- [ ] **Update UserProfileRepository** - Add email search
- [ ] **Update AppRouter** - Add invitation routes
- [ ] **Update Navigation** - Add notification navigation
- [ ] **Update DI Container** - Register new dependencies
- [ ] **Update Tests** - Add comprehensive tests

### Phase 8: Testing & Validation

**Status**: â³ **PENDING**

#### Tasks:

- [ ] **Unit Tests** - Test all use cases and entities
- [ ] **Integration Tests** - Test repository implementations
- [ ] **BLoC Tests** - Test all BLoCs
- [ ] **Widget Tests** - Test UI components
- [ ] **End-to-End Tests** - Test complete flows
- [ ] **Performance Tests** - Test with large datasets

### Phase 9: Documentation & Polish

**Status**: â³ **PENDING**

#### Tasks:

- [ ] **API Documentation** - Document all endpoints
- [ ] **User Documentation** - User guide for invitations
- [ ] **Developer Documentation** - Technical documentation
- [ ] **Code Comments** - Add comprehensive comments
- [ ] **Error Handling** - Improve error messages
- [ ] **Accessibility** - Ensure accessibility compliance

## Detailed Implementation Plan

### Invitation Flow

#### For Existing Users:

1. **Send Invitation** â†’ Create invitation record
2. **Create Notification** â†’ Notify user immediately
3. **User Sees Notification** â†’ In notification center
4. **User Accepts/Declines** â†’ Update invitation status
5. **Add to Project** â†’ Only after acceptance

#### For New Users:

1. **Send Invitation** â†’ Create invitation record
2. **Generate Magic Link** â†’ Create signup link
3. **Send Email** â†’ Email with magic link
4. **User Clicks Link** â†’ Opens app with signup
5. **User Signs Up** â†’ Create account
6. **Auto-Join Project** â†’ Automatically join project

### Notification System

#### Notification Types:

- **Project Invitation** - When invited to project
- **Invitation Accepted** - When invitation is accepted
- **Invitation Declined** - When invitation is declined
- **Collaborator Joined** - When someone joins project

#### Notification Features:

- **Real-time Updates** - Live notification updates
- **Badge Count** - Unread notification count
- **Mark as Read** - Individual and bulk mark as read
- **Notification Center** - Dedicated notification screen

### Magic Link Integration

#### Magic Link Flow:

1. **Generate Link** - Create unique invitation link
2. **Email Template** - Professional invitation email
3. **Deep Link** - App opens to invitation screen
4. **Signup Flow** - Streamlined signup process
5. **Auto-Join** - Automatically join project

## Success Metrics

### Performance Metrics:

- **App Startup Time** - < 2 seconds (no impact)
- **Invitation Send Time** - < 1 second
- **Notification Delivery** - < 500ms
- **Magic Link Processing** - < 2 seconds

### User Experience Metrics:

- **Invitation Acceptance Rate** - Target > 70%
- **Time to Accept Invitation** - Target < 24 hours
- **User Satisfaction** - Target > 4.5/5
- **Error Rate** - Target < 1%

### Technical Metrics:

- **Code Coverage** - Target > 90%
- **Test Pass Rate** - Target 100%
- **Build Time** - No significant increase
- **App Size** - < 5MB increase

## Risk Mitigation

### Technical Risks:

- **ID Constructor Issues** - Use existing ID patterns
- **Repository Dependencies** - Implement with TODOs
- **BLoC Complexity** - Keep Actor/Watcher separation
- **Database Schema** - Plan migration strategy

### User Experience Risks:

- **Notification Spam** - Implement rate limiting
- **Magic Link Security** - Use secure token generation
- **Email Delivery** - Use reliable email service
- **App Performance** - Monitor and optimize

## Next Steps

1. **Fix ID Constructor Issues** - Resolve InvitationId/NotificationId
2. **Start Phase 2** - Implement Data Layer
3. **Create Repository Implementations** - Local and remote data sources
4. **Add DTOs and Mappers** - Data transfer objects
5. **Implement BLoCs** - Actor and Watcher patterns

---

## ğŸ“‹ **COMPREHENSIVE TODO CHECKLIST**

### âœ… **Phase 1: Domain Layer** (13/13 tasks) - **COMPLETED**

- [x] Create `InvitationId` entity
- [x] Create `NotificationId` entity
- [x] Create `ProjectInvitation` entity with domain methods
- [x] Create `NotificationEntity` with factory methods
- [x] Create `InvitationRepository` interface (Actor/Watcher pattern)
- [x] Create `NotificationRepository` interface
- [x] Create `FindUserByEmailUseCase`
- [x] Create `SendInvitationUseCase` (existing + new users)
- [x] Create `AcceptInvitationUseCase` (accept + add to project)
- [x] Create `DeclineInvitationUseCase`
- [x] Create `ObservePendingInvitationsUseCase`
- [x] Create `ObserveSentInvitationsUseCase`
- [x] Create `ObserveNotificationsUseCase`
- [x] Create `MarkNotificationAsReadUseCase`
- [x] Create `MarkAllNotificationsAsReadUseCase`
- [x] Create `GetUnreadNotificationsCountUseCase`
- [x] Create `GetPendingInvitationsCountUseCase`
- [x] Create `CancelInvitationUseCase`
- [x] Create domain exceptions
- [x] Create domain failures
- [x] Create domain barrel file

### ğŸ”„ **Phase 2: Data Layer** (12 tasks) - **NEXT**

- [ ] Create `InvitationDto` data transfer object
- [ ] Create `NotificationDto` data transfer object
- [ ] Create `InvitationLocalDataSource` for local database
- [ ] Create `NotificationLocalDataSource` for local database
- [ ] Create `InvitationRemoteDataSource` for remote API
- [ ] Create `NotificationRemoteDataSource` for remote API
- [ ] Create `InvitationRepositoryImpl` implementation
- [ ] Create `NotificationRepositoryImpl` implementation
- [ ] Create `InvitationMapper` (Entity â†” DTO)
- [ ] Create `NotificationMapper` (Entity â†” DTO)
- [ ] Create data barrel file
- [ ] Add database schema migrations

### â³ **Phase 3: Split BLoCs** (8 tasks)

- [ ] Create `ProjectInvitationWatcherBloc` (observe state changes)
- [ ] Create `ProjectInvitationActorBloc` (handle user actions)
- [ ] Create `NotificationWatcherBloc` (observe notifications)
- [ ] Create `NotificationActorBloc` (handle notification actions)
- [ ] Create invitation states classes
- [ ] Create notification states classes
- [ ] Create invitation events classes
- [ ] Create notification events classes

### â³ **Phase 4: UI Components** (8 tasks)

- [ ] Create `SendInvitationForm` component
- [ ] Create `PendingInvitationsList` component
- [ ] Create `SentInvitationsList` component
- [ ] Create `InvitationCard` component
- [ ] Create `NotificationCenterScreen`
- [ ] Create `NotificationList` component
- [ ] Create `NotificationCard` component
- [ ] Create `InvitationActionButtons` (Accept/Decline)

### â³ **Phase 5: Notification System** (6 tasks)

- [ ] Create `NotificationBadge` component
- [ ] Create `NotificationIcon` component
- [ ] Create `NotificationDrawer` component
- [ ] Create `NotificationSettings` screen
- [ ] Add notification sound functionality
- [ ] Add notification vibration functionality

### â³ **Phase 6: Magic Link Integration** (7 tasks)

- [ ] Update existing `MagicLinkRepository` for invitations
- [ ] Create `InvitationMagicLink` entity
- [ ] Create `EmailTemplateService` for invitation emails
- [ ] Create `EmailSendingService` for sending emails
- [ ] Create `MagicLinkHandler` for invitation links
- [ ] Create `InvitationSignupFlow` for new users
- [ ] Implement `AutoJoinProject` functionality

### â³ **Phase 7: Integration & Updates** (6 tasks)

- [ ] Update `ProjectRepository` with collaborator management
- [ ] Update `UserProfileRepository` with email search
- [ ] Update `AppRouter` with invitation routes
- [ ] Update navigation with notification routes
- [ ] Update DI container with new dependencies
- [ ] Update existing tests and add new ones

### â³ **Phase 8: Testing & Validation** (6 tasks)

- [ ] Write unit tests for all use cases
- [ ] Write integration tests for repositories
- [ ] Write BLoC tests for all BLoCs
- [ ] Write widget tests for UI components
- [ ] Write end-to-end tests for complete flows
- [ ] Write performance tests for large datasets

### â³ **Phase 9: Documentation & Polish** (6 tasks)

- [ ] Write API documentation for all endpoints
- [ ] Write user documentation for invitation feature
- [ ] Write developer documentation for implementation
- [ ] Add comprehensive code comments
- [ ] Improve error handling and messages
- [ ] Ensure accessibility compliance

---

**Total Progress**: 13/74 tasks completed (17.6%)
**Current Phase**: Phase 1 âœ… COMPLETED
**Next Phase**: Phase 2 - Data Layer ğŸ”„
