name: ğŸ”¨ Build Develop (Internal)

on:
  push:
    branches: [develop]
  workflow_dispatch:

jobs:
  build-android:
    name: ğŸ¤– Build Android Development
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"

      - name: ğŸ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.29.3"
          channel: "stable"
          cache: true

      - name: ğŸ“¦ Instalar dependencias
        run: flutter pub get

      - name: ğŸ”§ Generar cÃ³digo
        run: flutter packages pub run build_runner build --delete-conflicting-outputs

      - name: ğŸ”§ Configure Flutter
        run: |
          flutter config --no-analytics
          flutter config --no-cli-animations

      - name: ğŸ”¨ Build APK Development
        run: |
          echo "ğŸš€ Building development flavor..."
          flutter build apk --flavor development --debug --verbose

      - name: âœ… Verificar build
        run: |
          apk_file="build/app/outputs/flutter-apk/app-development-debug.apk"
          if [ -f "$apk_file" ]; then
            echo "âœ… APK generado exitosamente"
            echo "ğŸ“ Archivo: $apk_file"
            echo "ğŸ“ TamaÃ±o: $(du -h $apk_file | cut -f1)"
            echo "apk_path=$apk_file" >> $GITHUB_OUTPUT
          else
            echo "âŒ APK no encontrado"
            ls -la build/app/outputs/flutter-apk/
            exit 1
          fi
        id: verify_build

      - name: ğŸ“± Subir a Firebase App Distribution (Internal-Dev)
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID_DEV }}
          serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          groups: internal-dev
          file: ${{ steps.verify_build.outputs.apk_path }}
          releaseNotes: |
            ğŸš€ Build automÃ¡tico de development

            ğŸ“± Branch: ${{ github.ref_name }}
            ğŸ”„ Commit: ${{ github.sha }}
            ğŸ‘¤ Autor: ${{ github.actor }}

            ğŸ“ Cambios recientes:
            ${{ github.event.head_commit.message }}

      - name: ğŸ“¦ Subir artefacto
        uses: actions/upload-artifact@v4
        with:
          name: trackflow-development-debug-apk
          path: ${{ steps.verify_build.outputs.apk_path }}
          retention-days: 7

  notify:
    name: ğŸ”” Notificar Resultado
    runs-on: ubuntu-latest
    needs: [build-android]
    if: always()

    steps:
      - name: ğŸ“¢ Notificar Ã©xito
        if: needs.build-android.result == 'success' && vars.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: success
          text: |
            âœ… Build development completado exitosamente
            ğŸ“± Rama: ${{ github.ref_name }}
            ğŸ‘¤ Autor: ${{ github.actor }}
            ğŸ¯ Distribuido a: internal-dev
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ğŸ“¢ Notificar fallo
        if: needs.build-android.result == 'failure' && vars.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: |
            âŒ Build development fallÃ³
            ğŸ“± Rama: ${{ github.ref_name }}
            ğŸ‘¤ Autor: ${{ github.actor }}
            ğŸ”— Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}