name: 🔨 Build Develop (Internal)

on:
  push:
    branches: [develop]
  workflow_dispatch:

jobs:
  build-android:
    name: 🤖 Build Android Development
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout código
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: ☕ Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"

      - name: 🎯 Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.29.3"
          channel: "stable"
          cache: true

      - name: 📦 Instalar dependencias
        run: flutter pub get

      - name: 🔧 Generar código
        run: flutter packages pub run build_runner build --delete-conflicting-outputs

      - name: 🔧 Configure Flutter
        run: |
          flutter config --no-analytics
          flutter config --no-cli-animations

      - name: 🔨 Build APK Development
        run: |
          echo "🚀 Building development flavor..."
          flutter build apk --flavor development --debug --verbose

      - name: ✅ Verificar build
        run: |
          apk_file="build/app/outputs/flutter-apk/app-development-debug.apk"
          if [ -f "$apk_file" ]; then
            echo "✅ APK generado exitosamente"
            echo "📁 Archivo: $apk_file"
            echo "📏 Tamaño: $(du -h $apk_file | cut -f1)"
            echo "apk_path=$apk_file" >> $GITHUB_OUTPUT
          else
            echo "❌ APK no encontrado"
            ls -la build/app/outputs/flutter-apk/
            exit 1
          fi
        id: verify_build

      - name: 📱 Subir a Firebase App Distribution (Internal-Dev)
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID_DEV }}
          serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          groups: internal-dev
          file: ${{ steps.verify_build.outputs.apk_path }}
          releaseNotes: |
            🚀 Build automático de development

            📱 Branch: ${{ github.ref_name }}
            🔄 Commit: ${{ github.sha }}
            👤 Autor: ${{ github.actor }}

            📝 Cambios recientes:
            ${{ github.event.head_commit.message }}

      - name: 📦 Subir artefacto
        uses: actions/upload-artifact@v4
        with:
          name: trackflow-development-debug-apk
          path: ${{ steps.verify_build.outputs.apk_path }}
          retention-days: 7

  notify:
    name: 🔔 Notificar Resultado
    runs-on: ubuntu-latest
    needs: [build-android]
    if: always()

    steps:
      - name: 📢 Notificar éxito
        if: needs.build-android.result == 'success' && vars.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: success
          text: |
            ✅ Build development completado exitosamente
            📱 Rama: ${{ github.ref_name }}
            👤 Autor: ${{ github.actor }}
            🎯 Distribuido a: internal-dev
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: 📢 Notificar fallo
        if: needs.build-android.result == 'failure' && vars.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: |
            ❌ Build development falló
            📱 Rama: ${{ github.ref_name }}
            👤 Autor: ${{ github.actor }}
            🔗 Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}