name: ğŸ“± Deploy Firebase App Distribution

on:
  push:
    branches: [ develop ]
  workflow_dispatch:
    inputs:
      flavor:
        description: 'Flavor para distribuir'
        required: true
        default: 'staging'
        type: choice
        options:
        - development
        - staging
      release_notes:
        description: 'Notas de la versiÃ³n'
        required: false
        default: 'Build automÃ¡tico desde GitHub Actions'
        type: string
      testers_group:
        description: 'Grupo de testers'
        required: false
        default: 'qa-team'
        type: choice
        options:
        - qa-team
        - beta-testers
        - internal-team

jobs:
  deploy-android:
    name: ğŸ“± Distribuir Android
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        submodules: false
      
    - name: â˜• Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: ğŸ¯ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.29.3'
        channel: 'stable'
        cache: true
        
    - name: ğŸ“¦ Instalar dependencias
      run: flutter pub get
      
    - name: ğŸ”§ Generar cÃ³digo
      run: flutter packages pub run build_runner build --delete-conflicting-outputs
      
    - name: ğŸ”¨ Build APK para distribuciÃ³n
      run: |
        FLAVOR=${{ github.event.inputs.flavor || 'staging' }}
        echo "ğŸš€ Building $FLAVOR APK para distribuciÃ³n..."
        flutter build apk --flavor $FLAVOR --release --verbose
        
    - name: ğŸ“ Preparar notas de release
      id: release_notes
      run: |
        NOTES="${{ github.event.inputs.release_notes || 'Build automÃ¡tico desde GitHub Actions' }}"
        
        FULL_NOTES=$(cat << EOF
        ğŸš€ TrackFlow - Build AutomÃ¡tico
        
        ğŸ“± Flavor: ${{ github.event.inputs.flavor || 'staging' }}
        ğŸŒ¿ Branch: ${{ github.ref_name }}
        ğŸ”„ Commit: ${{ github.sha }}
        ğŸ‘¤ Autor: ${{ github.actor }}
        ğŸ“… Fecha: $(date '+%Y-%m-%d %H:%M:%S UTC')
        
        ğŸ“ Notas:
        $NOTES
        
        ğŸ”„ Ãšltimos cambios:
        ${{ github.event.head_commit.message }}
        
        ğŸ“¥ Instala y prueba las nuevas funcionalidades!
        EOF
        )
        
        echo "notes<<EOF" >> $GITHUB_OUTPUT
        echo "$FULL_NOTES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: ğŸ“± Distribuir a Firebase App Distribution
      uses: wzieba/Firebase-Distribution-Github-Action@v1
      with:
        appId: ${{ github.event.inputs.flavor == 'development' && secrets.FIREBASE_APP_ID_DEV || secrets.FIREBASE_APP_ID_STAGING }}
        serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        groups: ${{ github.event.inputs.testers_group || 'qa-team' }}
        file: build/app/outputs/flutter-apk/app-${{ github.event.inputs.flavor || 'staging' }}-release.apk
        releaseNotes: ${{ steps.release_notes.outputs.notes }}
        
    - name: ğŸ’¾ Guardar APK como artefacto
      uses: actions/upload-artifact@v4
      with:
        name: trackflow-${{ github.event.inputs.flavor || 'staging' }}-distribution-apk
        path: build/app/outputs/flutter-apk/app-${{ github.event.inputs.flavor || 'staging' }}-release.apk
        retention-days: 14
        
  notify-testers:
    name: ğŸ”” Notificar a Testers
    runs-on: ubuntu-latest
    needs: deploy-android
    
    steps:
    - name: ğŸ“§ Enviar notificaciÃ³n por Slack
      uses: 8398a7/action-slack@v3
      with:
        status: success
        text: |
          ğŸ“± Â¡Nueva versiÃ³n de TrackFlow disponible para testing!
          
          ğŸ¯ Flavor: ${{ github.event.inputs.flavor || 'staging' }}
          ğŸ‘¥ Grupo: ${{ github.event.inputs.testers_group || 'qa-team' }}
          ğŸŒ¿ Branch: ${{ github.ref_name }}
          
          ğŸ“ Notas: ${{ github.event.inputs.release_notes || 'Build automÃ¡tico desde GitHub Actions' }}
          
          ğŸ“¥ Descarga la app desde Firebase App Distribution
          ğŸ”— Link: https://appdistribution.firebase.dev/i/YOUR_DISTRIBUTION_ID
          
          ğŸ§ª Por favor, prueba y reporta cualquier issue encontrado.
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        
    - name: ğŸ“§ Enviar email a testers (opcional)
      if: github.event.inputs.testers_group == 'beta-testers'
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.GMAIL_USERNAME }}
        password: ${{ secrets.GMAIL_PASSWORD }}
        subject: ğŸš€ Nueva versiÃ³n de TrackFlow lista para testing
        to: ${{ secrets.BETA_TESTERS_EMAIL_LIST }}
        from: TrackFlow Team <${{ secrets.GMAIL_USERNAME }}>
        html_body: |
          <h2>ğŸš€ Nueva versiÃ³n de TrackFlow disponible</h2>
          
          <p>Â¡Hola Beta Testers!</p>
          
          <p>Tenemos una nueva versiÃ³n de TrackFlow lista para que la prueben:</p>
          
          <ul>
            <li><strong>Flavor:</strong> ${{ github.event.inputs.flavor || 'staging' }}</li>
            <li><strong>Branch:</strong> ${{ github.ref_name }}</li>
            <li><strong>Fecha:</strong> $(date '+%Y-%m-%d %H:%M:%S UTC')</li>
          </ul>
          
          <h3>ğŸ“ Notas de esta versiÃ³n:</h3>
          <p>${{ github.event.inputs.release_notes || 'Build automÃ¡tico desde GitHub Actions' }}</p>
          
          <h3>ğŸ“¥ CÃ³mo descargar:</h3>
          <ol>
            <li>Abre Firebase App Distribution en tu dispositivo</li>
            <li>Busca "TrackFlow"</li>
            <li>Descarga e instala la nueva versiÃ³n</li>
          </ol>
          
          <p><strong>ğŸ”— Link directo:</strong> <a href="https://appdistribution.firebase.dev/i/YOUR_DISTRIBUTION_ID">Descargar TrackFlow</a></p>
          
          <h3>ğŸ§ª QuÃ© probar:</h3>
          <ul>
            <li>Funcionalidades principales de la app</li>
            <li>Cualquier nueva caracterÃ­stica mencionada en las notas</li>
            <li>Reportar bugs o issues encontrados</li>
          </ul>
          
          <p>Â¡Gracias por ayudarnos a mejorar TrackFlow! ğŸµ</p>
          
          <hr>
          <p><small>Este email fue enviado automÃ¡ticamente por GitHub Actions.</small></p>
          
  deploy-ios:
    name: ğŸ Distribuir iOS (TestFlight)
    runs-on: macos-latest
    if: github.event.inputs.flavor != 'development'
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        submodules: false
      
    - name: ğŸ¯ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.29.3'
        channel: 'stable'
        cache: true
        
    - name: ğŸ”§ Configurar certificados iOS
      uses: apple-actions/import-codesign-certs@v3
      with:
        p12-file-base64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
        p12-password: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
        
    - name: ğŸ”§ Configurar provisioning profile
      uses: apple-actions/download-provisioning-profiles@v3
      with:
        bundle-id: com.trackflow${{ github.event.inputs.flavor == 'staging' && '.staging' || '' }}
        issuer-id: ${{ secrets.APPLE_ISSUER_ID }}
        api-key-id: ${{ secrets.APPLE_API_KEY_ID }}
        api-private-key: ${{ secrets.APPLE_API_PRIVATE_KEY }}
        
    - name: ğŸ“¦ Instalar dependencias
      run: flutter pub get
      
    - name: ğŸ”§ Generar cÃ³digo
      run: flutter packages pub run build_runner build --delete-conflicting-outputs
      
    - name: ğŸ”¨ Build iOS para distribuciÃ³n
      run: |
        FLAVOR=${{ github.event.inputs.flavor || 'staging' }}
        echo "ğŸš€ Building iOS $FLAVOR para TestFlight..."
        flutter build ipa --flavor $FLAVOR --release --verbose
        
    - name: ğŸ Subir a TestFlight
      uses: apple-actions/upload-testflight-build@v1
      with:
        app-path: build/ios/ipa/trackflow.ipa
        issuer-id: ${{ secrets.APPLE_ISSUER_ID }}
        api-key-id: ${{ secrets.APPLE_API_KEY_ID }}
        api-private-key: ${{ secrets.APPLE_API_PRIVATE_KEY }}
        
    - name: ğŸ’¾ Guardar IPA como artefacto
      uses: actions/upload-artifact@v4
      with:
        name: trackflow-${{ github.event.inputs.flavor || 'staging' }}-testflight-ipa
        path: build/ios/ipa/trackflow.ipa
        retention-days: 14