name: 📱 Deploy Firebase App Distribution

on:
  push:
    branches: [ develop ]
  workflow_dispatch:
    inputs:
      flavor:
        description: 'Flavor para distribuir'
        required: true
        default: 'staging'
        type: choice
        options:
        - development
        - staging
      release_notes:
        description: 'Notas de la versión'
        required: false
        default: 'Build automático desde GitHub Actions'
        type: string
      testers_group:
        description: 'Grupo de testers'
        required: false
        default: 'qa-team'
        type: choice
        options:
        - qa-team
        - beta-testers
        - internal-team

jobs:
  deploy-android:
    name: 📱 Distribuir Android
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout código
      uses: actions/checkout@v4
      with:
        submodules: false
      
    - name: ☕ Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: 🎯 Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.29.3'
        channel: 'stable'
        cache: true
        
    - name: 📦 Instalar dependencias
      run: flutter pub get
      
    - name: 🔧 Generar código
      run: flutter packages pub run build_runner build --delete-conflicting-outputs
      
    - name: 🔨 Build APK para distribución
      run: |
        FLAVOR=${{ github.event.inputs.flavor || 'staging' }}
        echo "🚀 Building $FLAVOR APK para distribución..."
        flutter build apk --flavor $FLAVOR --release --verbose
        
    - name: 📝 Preparar notas de release
      id: release_notes
      run: |
        NOTES="${{ github.event.inputs.release_notes || 'Build automático desde GitHub Actions' }}"
        
        FULL_NOTES=$(cat << EOF
        🚀 TrackFlow - Build Automático
        
        📱 Flavor: ${{ github.event.inputs.flavor || 'staging' }}
        🌿 Branch: ${{ github.ref_name }}
        🔄 Commit: ${{ github.sha }}
        👤 Autor: ${{ github.actor }}
        📅 Fecha: $(date '+%Y-%m-%d %H:%M:%S UTC')
        
        📝 Notas:
        $NOTES
        
        🔄 Últimos cambios:
        ${{ github.event.head_commit.message }}
        
        📥 Instala y prueba las nuevas funcionalidades!
        EOF
        )
        
        echo "notes<<EOF" >> $GITHUB_OUTPUT
        echo "$FULL_NOTES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: 📱 Distribuir a Firebase App Distribution
      uses: wzieba/Firebase-Distribution-Github-Action@v1
      with:
        appId: ${{ github.event.inputs.flavor == 'development' && secrets.FIREBASE_APP_ID_DEV || secrets.FIREBASE_APP_ID_STAGING }}
        serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        groups: ${{ github.event.inputs.testers_group || 'qa-team' }}
        file: build/app/outputs/flutter-apk/app-${{ github.event.inputs.flavor || 'staging' }}-release.apk
        releaseNotes: ${{ steps.release_notes.outputs.notes }}
        
    - name: 💾 Guardar APK como artefacto
      uses: actions/upload-artifact@v4
      with:
        name: trackflow-${{ github.event.inputs.flavor || 'staging' }}-distribution-apk
        path: build/app/outputs/flutter-apk/app-${{ github.event.inputs.flavor || 'staging' }}-release.apk
        retention-days: 14
        
  notify-testers:
    name: 🔔 Notificar a Testers
    runs-on: ubuntu-latest
    needs: deploy-android
    
    steps:
    - name: 📧 Enviar notificación por Slack
      uses: 8398a7/action-slack@v3
      with:
        status: success
        text: |
          📱 ¡Nueva versión de TrackFlow disponible para testing!
          
          🎯 Flavor: ${{ github.event.inputs.flavor || 'staging' }}
          👥 Grupo: ${{ github.event.inputs.testers_group || 'qa-team' }}
          🌿 Branch: ${{ github.ref_name }}
          
          📝 Notas: ${{ github.event.inputs.release_notes || 'Build automático desde GitHub Actions' }}
          
          📥 Descarga la app desde Firebase App Distribution
          🔗 Link: https://appdistribution.firebase.dev/i/YOUR_DISTRIBUTION_ID
          
          🧪 Por favor, prueba y reporta cualquier issue encontrado.
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        
    - name: 📧 Enviar email a testers (opcional)
      if: github.event.inputs.testers_group == 'beta-testers'
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.GMAIL_USERNAME }}
        password: ${{ secrets.GMAIL_PASSWORD }}
        subject: 🚀 Nueva versión de TrackFlow lista para testing
        to: ${{ secrets.BETA_TESTERS_EMAIL_LIST }}
        from: TrackFlow Team <${{ secrets.GMAIL_USERNAME }}>
        html_body: |
          <h2>🚀 Nueva versión de TrackFlow disponible</h2>
          
          <p>¡Hola Beta Testers!</p>
          
          <p>Tenemos una nueva versión de TrackFlow lista para que la prueben:</p>
          
          <ul>
            <li><strong>Flavor:</strong> ${{ github.event.inputs.flavor || 'staging' }}</li>
            <li><strong>Branch:</strong> ${{ github.ref_name }}</li>
            <li><strong>Fecha:</strong> $(date '+%Y-%m-%d %H:%M:%S UTC')</li>
          </ul>
          
          <h3>📝 Notas de esta versión:</h3>
          <p>${{ github.event.inputs.release_notes || 'Build automático desde GitHub Actions' }}</p>
          
          <h3>📥 Cómo descargar:</h3>
          <ol>
            <li>Abre Firebase App Distribution en tu dispositivo</li>
            <li>Busca "TrackFlow"</li>
            <li>Descarga e instala la nueva versión</li>
          </ol>
          
          <p><strong>🔗 Link directo:</strong> <a href="https://appdistribution.firebase.dev/i/YOUR_DISTRIBUTION_ID">Descargar TrackFlow</a></p>
          
          <h3>🧪 Qué probar:</h3>
          <ul>
            <li>Funcionalidades principales de la app</li>
            <li>Cualquier nueva característica mencionada en las notas</li>
            <li>Reportar bugs o issues encontrados</li>
          </ul>
          
          <p>¡Gracias por ayudarnos a mejorar TrackFlow! 🎵</p>
          
          <hr>
          <p><small>Este email fue enviado automáticamente por GitHub Actions.</small></p>
          
  deploy-ios:
    name: 🍎 Distribuir iOS (TestFlight)
    runs-on: macos-latest
    if: github.event.inputs.flavor != 'development'
    
    steps:
    - name: 📥 Checkout código
      uses: actions/checkout@v4
      with:
        submodules: false
      
    - name: 🎯 Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.29.3'
        channel: 'stable'
        cache: true
        
    - name: 🔧 Configurar certificados iOS
      uses: apple-actions/import-codesign-certs@v3
      with:
        p12-file-base64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
        p12-password: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
        
    - name: 🔧 Configurar provisioning profile
      uses: apple-actions/download-provisioning-profiles@v3
      with:
        bundle-id: com.trackflow${{ github.event.inputs.flavor == 'staging' && '.staging' || '' }}
        issuer-id: ${{ secrets.APPLE_ISSUER_ID }}
        api-key-id: ${{ secrets.APPLE_API_KEY_ID }}
        api-private-key: ${{ secrets.APPLE_API_PRIVATE_KEY }}
        
    - name: 📦 Instalar dependencias
      run: flutter pub get
      
    - name: 🔧 Generar código
      run: flutter packages pub run build_runner build --delete-conflicting-outputs
      
    - name: 🔨 Build iOS para distribución
      run: |
        FLAVOR=${{ github.event.inputs.flavor || 'staging' }}
        echo "🚀 Building iOS $FLAVOR para TestFlight..."
        flutter build ipa --flavor $FLAVOR --release --verbose
        
    - name: 🍎 Subir a TestFlight
      uses: apple-actions/upload-testflight-build@v1
      with:
        app-path: build/ios/ipa/trackflow.ipa
        issuer-id: ${{ secrets.APPLE_ISSUER_ID }}
        api-key-id: ${{ secrets.APPLE_API_KEY_ID }}
        api-private-key: ${{ secrets.APPLE_API_PRIVATE_KEY }}
        
    - name: 💾 Guardar IPA como artefacto
      uses: actions/upload-artifact@v4
      with:
        name: trackflow-${{ github.event.inputs.flavor || 'staging' }}-testflight-ipa
        path: build/ios/ipa/trackflow.ipa
        retention-days: 14