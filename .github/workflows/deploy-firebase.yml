name: 📱 Deploy Firebase App Distribution

on:
  push:
    branches: [ develop ]
  workflow_dispatch:
    inputs:
      flavor:
        description: 'Flavor to distribute'
        required: true
        default: 'staging'
        type: choice
        options:
        - development
        - staging
      release_notes:
        description: 'Release notes'
        required: false
        default: 'Automatic build from GitHub Actions'
        type: string
      testers_group:
        description: 'Testers group'
        required: false
        default: 'qa-team'
        type: choice
        options:
        - qa-team
        - beta-testers
        - internal-team

jobs:
  deploy-android:
    name: 📱 Distribute Android
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
      with:
        submodules: false
      
    - name: ☕ Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: 🎯 Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.29.3'
        channel: 'stable'
        cache: true
        
    - name: 📦 Install dependencies
      run: flutter pub get
      
    - name: 🔧 Generate code
      run: flutter packages pub run build_runner build --delete-conflicting-outputs
      
    - name: 🔨 Build APK for distribution
      run: |
        FLAVOR=${{ github.event.inputs.flavor || 'staging' }}
        echo "🚀 Building $FLAVOR APK for distribution..."
        flutter build apk --flavor $FLAVOR --release --verbose
        
    - name: 📝 Prepare release notes
      id: release_notes
      run: |
        NOTES="${{ github.event.inputs.release_notes || 'Automatic build from GitHub Actions' }}"
        
        FULL_NOTES=$(cat << EOF
        🚀 TrackFlow - Automatic Build
        
        📱 Flavor: ${{ github.event.inputs.flavor || 'staging' }}
        🌿 Branch: ${{ github.ref_name }}
        🔄 Commit: ${{ github.sha }}
        👤 Author: ${{ github.actor }}
        📅 Date: $(date '+%Y-%m-%d %H:%M:%S UTC')
        
        📝 Notes:
        $NOTES
        
        🔄 Latest changes:
        ${{ github.event.head_commit.message }}
        
        📥 Install and test the new features!
        EOF
        )
        
        echo "notes<<EOF" >> $GITHUB_OUTPUT
        echo "$FULL_NOTES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: 📱 Distribute to Firebase App Distribution
      uses: wzieba/Firebase-Distribution-Github-Action@v1
      with:
        appId: ${{ github.event.inputs.flavor == 'development' && secrets.FIREBASE_APP_ID_DEV || secrets.FIREBASE_APP_ID_STAGING }}
        serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        groups: ${{ github.event.inputs.testers_group || 'qa-team' }}
        file: build/app/outputs/flutter-apk/app-${{ github.event.inputs.flavor || 'staging' }}-release.apk
        releaseNotes: ${{ steps.release_notes.outputs.notes }}
        
    - name: 💾 Save APK as artifact
      uses: actions/upload-artifact@v4
      with:
        name: trackflow-${{ github.event.inputs.flavor || 'staging' }}-distribution-apk
        path: build/app/outputs/flutter-apk/app-${{ github.event.inputs.flavor || 'staging' }}-release.apk
        retention-days: 14
        
  notify-testers:
    name: 🔔 Notify Testers
    runs-on: ubuntu-latest
    needs: deploy-android
    
    steps:
    - name: 📧 Send Slack notification
      uses: 8398a7/action-slack@v3
      with:
        status: success
        text: |
          📱 New version of TrackFlow available for testing!
          
          🎯 Flavor: ${{ github.event.inputs.flavor || 'staging' }}
          👥 Group: ${{ github.event.inputs.testers_group || 'qa-team' }}
          🌿 Branch: ${{ github.ref_name }}
          
          📝 Notes: ${{ github.event.inputs.release_notes || 'Automatic build from GitHub Actions' }}
          
          📥 Download the app from Firebase App Distribution
          🔗 Link: https://appdistribution.firebase.dev/i/YOUR_DISTRIBUTION_ID
          
          🧪 Please test and report any issues found.
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        
    - name: 📧 Send email to testers (optional)
      if: github.event.inputs.testers_group == 'beta-testers'
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.GMAIL_USERNAME }}
        password: ${{ secrets.GMAIL_PASSWORD }}
        subject: 🚀 New version of TrackFlow ready for testing
        to: ${{ secrets.BETA_TESTERS_EMAIL_LIST }}
        from: TrackFlow Team <${{ secrets.GMAIL_USERNAME }}>
        html_body: |
          <h2>🚀 New version of TrackFlow available</h2>
          
          <p>Hello Beta Testers!</p>
          
          <p>We have a new version of TrackFlow ready for you to test:</p>
          
          <ul>
            <li><strong>Flavor:</strong> ${{ github.event.inputs.flavor || 'staging' }}</li>
            <li><strong>Branch:</strong> ${{ github.ref_name }}</li>
            <li><strong>Date:</strong> $(date '+%Y-%m-%d %H:%M:%S UTC')</li>
          </ul>
          
          <h3>📝 Notes for this version:</h3>
          <p>${{ github.event.inputs.release_notes || 'Automatic build from GitHub Actions' }}</p>
          
          <h3>📥 How to download:</h3>
          <ol>
            <li>Open Firebase App Distribution on your device</li>
            <li>Search for "TrackFlow"</li>
            <li>Download and install the new version</li>
          </ol>
          
          <p><strong>🔗 Direct link:</strong> <a href="https://appdistribution.firebase.dev/i/YOUR_DISTRIBUTION_ID">Download TrackFlow</a></p>
          
          <h3>🧪 What to test:</h3>
          <ul>
            <li>Main app functionalities</li>
            <li>Any new features mentioned in the notes</li>
            <li>Report any bugs or issues found</li>
          </ul>
          
          <p>Thank you for helping us improve TrackFlow! 🎵</p>
          
          <hr>
          <p><small>This email was automatically sent by GitHub Actions.</small></p>
          
  deploy-ios:
    name: 🍎 Distribute iOS (TestFlight)
    runs-on: macos-latest
    if: github.event.inputs.flavor != 'development'
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
      with:
        submodules: false
      
    - name: 🎯 Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.29.3'
        channel: 'stable'
        cache: true
        
    - name: 🔧 Configure iOS certificates
      uses: apple-actions/import-codesign-certs@v3
      with:
        p12-file-base64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
        p12-password: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
        
    - name: 🔧 Configure provisioning profile
      uses: apple-actions/download-provisioning-profiles@v3
      with:
        bundle-id: com.trackflow${{ github.event.inputs.flavor == 'staging' && '.staging' || '' }}
        issuer-id: ${{ secrets.APPLE_ISSUER_ID }}
        api-key-id: ${{ secrets.APPLE_API_KEY_ID }}
        api-private-key: ${{ secrets.APPLE_API_PRIVATE_KEY }}
        
    - name: 📦 Install dependencies
      run: flutter pub get
      
    - name: 🔧 Generate code
      run: flutter packages pub run build_runner build --delete-conflicting-outputs
      
    - name: 🔨 Build iOS for distribution
      run: |
        FLAVOR=${{ github.event.inputs.flavor || 'staging' }}
        echo "🚀 Building iOS $FLAVOR for TestFlight..."
        flutter build ipa --flavor $FLAVOR --release --verbose
        
    - name: 🍎 Upload to TestFlight
      uses: apple-actions/upload-testflight-build@v1
      with:
        app-path: build/ios/ipa/trackflow.ipa
        issuer-id: ${{ secrets.APPLE_ISSUER_ID }}
        api-key-id: ${{ secrets.APPLE_API_KEY_ID }}
        api-private-key: ${{ secrets.APPLE_API_PRIVATE_KEY }}
        
    - name: 💾 Save IPA as artifact
      uses: actions/upload-artifact@v4
      with:
        name: trackflow-${{ github.event.inputs.flavor || 'staging' }}-testflight-ipa
        path: build/ios/ipa/trackflow.ipa
        retention-days: 14