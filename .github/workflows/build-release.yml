name: ğŸš€ Build Release - Production

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string
      upload_to_stores:
        description: 'Upload to app stores'
        required: false
        default: false
        type: boolean

jobs:
  prepare:
    name: ğŸ·ï¸ Preparar Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_number: ${{ steps.version.outputs.build_number }}
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        submodules: false
      
    - name: ğŸ·ï¸ Determinar versiÃ³n
      id: version
      run: |
        if [ "${{ github.event_name }}" = "push" ]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        else
          VERSION="${{ github.event.inputs.version }}"
        fi
        
        BUILD_NUMBER=$(date +%s)
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
        echo "ğŸ·ï¸ VersiÃ³n: $VERSION+$BUILD_NUMBER"
        
  build-android-release:
    name: ğŸ¤– Build Android Release
    runs-on: ubuntu-latest
    needs: prepare
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        submodules: false
      
    - name: â˜• Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: ğŸ¯ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.29.3'
        channel: 'stable'
        cache: true
        
    - name: ğŸ”§ Configurar keystore
      run: |
        echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/keystore/trackflow-release-key.keystore
        echo "storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" > android/key.properties
        echo "keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}" >> android/key.properties
        echo "keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}" >> android/key.properties
        echo "storeFile=../keystore/trackflow-release-key.keystore" >> android/key.properties
        
    - name: ğŸ“¦ Instalar dependencias
      run: flutter pub get
      
    - name: ğŸ”§ Generar cÃ³digo
      run: flutter packages pub run build_runner build --delete-conflicting-outputs
      
    - name: ğŸ—ï¸ Actualizar versiÃ³n
      run: |
        sed -i "s/version: .*/version: ${{ needs.prepare.outputs.version }}+${{ needs.prepare.outputs.build_number }}/" pubspec.yaml
        
    - name: ğŸ”¨ Build App Bundle Release
      run: |
        echo "ğŸš€ Building production app bundle..."
        flutter build appbundle --flavor production --release --verbose
        
    - name: âœ… Verificar App Bundle
      run: |
        aab_file="build/app/outputs/bundle/productionRelease/app-production-release.aab"
        if [ -f "$aab_file" ]; then
          echo "âœ… App Bundle generado exitosamente"
          echo "ğŸ“ Archivo: $aab_file"
          echo "ğŸ“ TamaÃ±o: $(du -h $aab_file | cut -f1)"
        else
          echo "âŒ App Bundle no encontrado"
          ls -la build/app/outputs/bundle/productionRelease/
          exit 1
        fi
        
    - name: ğŸ“¦ Subir App Bundle
      uses: actions/upload-artifact@v4
      with:
        name: trackflow-production-release-aab-v${{ needs.prepare.outputs.version }}
        path: build/app/outputs/bundle/productionRelease/app-production-release.aab
        retention-days: 30
        
    - name: ğŸª Subir a Google Play Store
      if: github.event.inputs.upload_to_stores == 'true'
      uses: r0adkll/upload-google-play@v1.1.3
      with:
        serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
        packageName: com.trackflow
        releaseFiles: build/app/outputs/bundle/productionRelease/app-production-release.aab
        track: internal # Cambiar a 'production' cuando estÃ© listo
        status: completed
        releaseNotes: |
          ğŸš€ TrackFlow v${{ needs.prepare.outputs.version }}
          
          Nuevas caracterÃ­sticas y mejoras en esta versiÃ³n.
          
          Para mÃ¡s detalles, visita: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.prepare.outputs.version }}
          
  build-ios-release:
    name: ğŸ Build iOS Release
    runs-on: macos-latest
    needs: prepare
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        submodules: false
      
    - name: ğŸ¯ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.29.3'
        channel: 'stable'
        cache: true
        
    - name: ğŸ”§ Configurar certificados iOS
      uses: apple-actions/import-codesign-certs@v3
      with:
        p12-file-base64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
        p12-password: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
        
    - name: ğŸ”§ Configurar provisioning profile
      uses: apple-actions/download-provisioning-profiles@v3
      with:
        bundle-id: com.trackflow
        issuer-id: ${{ secrets.APPLE_ISSUER_ID }}
        api-key-id: ${{ secrets.APPLE_API_KEY_ID }}
        api-private-key: ${{ secrets.APPLE_API_PRIVATE_KEY }}
        
    - name: ğŸ“¦ Instalar dependencias
      run: flutter pub get
      
    - name: ğŸ”§ Generar cÃ³digo
      run: flutter packages pub run build_runner build --delete-conflicting-outputs
      
    - name: ğŸ—ï¸ Actualizar versiÃ³n
      run: |
        sed -i '' "s/version: .*/version: ${{ needs.prepare.outputs.version }}+${{ needs.prepare.outputs.build_number }}/" pubspec.yaml
        
    - name: ğŸ”¨ Build iOS Release
      run: |
        echo "ğŸš€ Building iOS production release..."
        flutter build ipa --flavor production --release --verbose
        
    - name: âœ… Verificar IPA
      run: |
        ipa_file="build/ios/ipa/trackflow.ipa"
        if [ -f "$ipa_file" ]; then
          echo "âœ… IPA generado exitosamente"
          echo "ğŸ“ Archivo: $ipa_file"
          echo "ğŸ“ TamaÃ±o: $(du -h $ipa_file | cut -f1)"
        else
          echo "âŒ IPA no encontrado"
          ls -la build/ios/ipa/
          exit 1
        fi
        
    - name: ğŸ“¦ Subir IPA
      uses: actions/upload-artifact@v4
      with:
        name: trackflow-production-release-ipa-v${{ needs.prepare.outputs.version }}
        path: build/ios/ipa/trackflow.ipa
        retention-days: 30
        
    - name: ğŸ Subir a App Store Connect
      if: github.event.inputs.upload_to_stores == 'true'
      uses: apple-actions/upload-testflight-build@v1
      with:
        app-path: build/ios/ipa/trackflow.ipa
        issuer-id: ${{ secrets.APPLE_ISSUER_ID }}
        api-key-id: ${{ secrets.APPLE_API_KEY_ID }}
        api-private-key: ${{ secrets.APPLE_API_PRIVATE_KEY }}
        
  create-release:
    name: ğŸ·ï¸ Crear GitHub Release
    runs-on: ubuntu-latest
    needs: [prepare, build-android-release, build-ios-release]
    if: always() && (needs.build-android-release.result == 'success' || needs.build-ios-release.result == 'success')
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        submodules: false
      
    - name: ğŸ“¥ Descargar artefactos Android
      if: needs.build-android-release.result == 'success'
      uses: actions/download-artifact@v4
      with:
        name: trackflow-production-release-aab-v${{ needs.prepare.outputs.version }}
        path: ./artifacts/
        
    - name: ğŸ“¥ Descargar artefactos iOS
      if: needs.build-ios-release.result == 'success'
      uses: actions/download-artifact@v4
      with:
        name: trackflow-production-release-ipa-v${{ needs.prepare.outputs.version }}
        path: ./artifacts/
        
    - name: ğŸ·ï¸ Crear Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ needs.prepare.outputs.version }}
        name: TrackFlow v${{ needs.prepare.outputs.version }}
        body: |
          ğŸš€ **TrackFlow v${{ needs.prepare.outputs.version }}**
          
          ## ğŸ“± Archivos de Release
          
          ${{ needs.build-android-release.result == 'success' && '- âœ… Android App Bundle (.aab) para Google Play Store' || '- âŒ Android build fallÃ³' }}
          ${{ needs.build-ios-release.result == 'success' && '- âœ… iOS Archive (.ipa) para App Store' || '- âŒ iOS build fallÃ³' }}
          
          ## ğŸ”„ Cambios en esta versiÃ³n
          
          Ver commits desde la versiÃ³n anterior para detalles completos.
          
          ## ğŸ“‹ InstalaciÃ³n
          
          - **Android**: Subir el archivo .aab a Google Play Console
          - **iOS**: Subir el archivo .ipa a App Store Connect
          
          ---
          
          ğŸ¤– Release generado automÃ¡ticamente por GitHub Actions
        files: ./artifacts/*
        draft: false
        prerelease: false
        
  notify-release:
    name: ğŸ”” Notificar Release
    runs-on: ubuntu-latest
    needs: [prepare, build-android-release, build-ios-release, create-release]
    if: always()
    
    steps:
    - name: ğŸ“¢ Notificar Ã©xito
      if: needs.create-release.result == 'success'
      uses: 8398a7/action-slack@v3
      with:
        status: success
        text: |
          ğŸ‰ Â¡Release v${{ needs.prepare.outputs.version }} completado!
          
          âœ… Android: ${{ needs.build-android-release.result == 'success' && 'Exitoso' || 'FallÃ³' }}
          âœ… iOS: ${{ needs.build-ios-release.result == 'success' && 'Exitoso' || 'FallÃ³' }}
          
          ğŸ”— Release: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.prepare.outputs.version }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        
    - name: ğŸ“¢ Notificar fallo
      if: needs.build-android-release.result == 'failure' || needs.build-ios-release.result == 'failure'
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        text: |
          âŒ Release v${{ needs.prepare.outputs.version }} fallÃ³
          
          Android: ${{ needs.build-android-release.result }}
          iOS: ${{ needs.build-ios-release.result }}
          
          ğŸ”— Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}